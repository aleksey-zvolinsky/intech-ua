<script type="text/javascript" src="/js/wz_tooltip.js"></script>
<script type="text/javascript">
	function setVisible( elname, value ) {
		if ( value ) {
			$(elname+'1').show();
			$(elname+'0').hide();
		} else {
			$(elname+'1').hide();
			$(elname+'0').show();
		}
	}
	function setPumpFailure( el, failure ) {
		el.removeClassName('failure'+(failure?'off':'on'));
		el.removeClassName('failure'+(failure?'off1':'on1'));
		el.addClassName('failure'+(failure?'on':'off'));
	}
	function setEnabled( elname, value ) {
		$('cmd_'+elname).disabled = !value;
	}
	function refreshStatus(pe) {
		new Ajax.Request('/status?json=1&id=$ch.id', {
			method:'get',
			onSuccess: function(transport){
				var status = transport.responseText.evalJSON();
				$('connected').writeAttribute( 'src', status.connected ? 'img/flag-link-on.png' : 'img/flag-link-off.png' );
				$('journalize').disabled = !status.submit_required;
				if ( status.msg ) {
					#if ( $ch.getPumpState(3).id() != 0 )
						$('voltage1').writeAttribute( 'src', status.msg.voltage_ok ? 'img/flag-voltage1-on.png' : 'img/flag-voltage1-off.png' );
						$('voltage2').writeAttribute( 'src', status.msg.voltage2_ok ? 'img/flag-voltage2-on.png' : 'img/flag-voltage2-off.png' );
						$('adj').writeAttribute( 'src', status.msg.adj_pressed ? 'img/flag-adj-off.png' : 'img/flag-adj-on.png' );
					#else
						$('voltage').writeAttribute( 'src', status.msg.voltage_ok ? 'img/flag-voltage-on.png' : 'img/flag-voltage-off.png' );
					#end
					$('mode').writeAttribute( 'src', status.msg.automatic_mode ? 'img/flag-mode-automatic.png' : 'img/flag-mode-manual.png' );
					$('date').update( status.msg.date );
					var tank = '0';
					if ( status.msg.tank.failure ) {
						tank = 'fail';
					} else {
						tank = ''+status.msg.tank.level;
					}
					$('tank').writeAttribute( 'src', 'img/tank-big-'+tank+'.png' );
					for ( var p=0; p<4; p++ ) {
						var state = 'none';
						if ( status.msg.pumps[p] ) {
							var pump = status.msg.pumps[p];
							var statetxt = '';
							//if ( pump.failure ) { // = 3
							//	statetxt = "Работа";
							//	state = 'on';
							//} else if ( pump.working ) { // = 2
							//	statetxt = "Стоп";
							//	state = 'off';
							//} else if ( pump.modbus1_failure ) { // = 0
							//	statetxt = "Вiдс.зв'язок";
							//	state = 'none';
							//} else { // = 1
							//	statetxt = "";
							//	state = 'fail';
							//}
							if ( pump.failure ) {
								statetxt = "Авария";
								state = 'fail';
							} else if ( pump.working ) {
								statetxt = "Работа";
								state = 'on';
							} else if ( pump.modbus1_failure ) {
								statetxt = "Нет связи";
								state = 'none';
							} else {
								statetxt = "Стоп";
								state = 'off';
							}
							
							var modetxt = '';
							if ( pump.modbus2_failure ) {
								modetxt = "Нет связи";
							} else if ( pump.manual_mode && !pump.automatic_mode ) {
								modetxt = "Ручной";
							} else if ( !pump.manual_mode && pump.automatic_mode ) {
								modetxt = "Автомат.";
							} else {
								modetxt = "Не выбран";
							}
							
							
							$('pump'+p+'_wm').update( modetxt );
							$('pump'+p+'_st').update( statetxt );
							$('pump'+p+'_c1').update( pump.c1 );
							$('pump'+p+'_c2').update( pump.c2 );
							$('pump'+p+'_c3').update( pump.c3 );
							$('pump'+p+'_v').update( pump.v );
							#if ( $ch.getPumpState(3).id() != 0 )
								$('pump'+p+'_mh').update( pump.moto_hours+':'+pump.moto_mins );
							#else
								$('pump'+p+'_mh').update( pump.moto_hours );
							#end
							
							if ( pump.fail_code ) {
								if ( pump.fail_code.code > 0 ) {
									$('pump'+p+'_fc').update( pump.fail_code.code+' - '+pump.fail_code.nik );
									$('pump'+p+'_fcf').update( pump.fail_code.name );
								} else {
									$('pump'+p+'_fc').update( '' );
								}
							} else {
								$('pump'+p+'_fc').update( '?' );
							}
							//$('pump'+p+'mode').writeAttribute( 'src', 'img/pump'+p+'-mode-'+modeimg+'.png' );
							setPumpFailure( $('pump'+p+'_fe'), pump.engine_failure );
							setPumpFailure( $('pump'+p+'_fs'), pump.start_failure );
							setPumpFailure( $('pump'+p+'_fm'), pump.modbus_failure );
							setPumpFailure( $('pump'+p+'_hco'), pump.hours_counter_overflow );
							#if ( $ch.getPumpState(3).id() != 0 )
							setPumpFailure( $('pump'+p+'_fqf'), pump.qf_failure );
							#end
						}
						$('pump'+p).writeAttribute( 'src', 'img/pump-big-'+state+'.png' );
					}
				} else {
					$('date').update( '--' );
				}
			}
		});
	}
	function refreshStatusFirst(pe) {
		refreshStatus(pe);
		pe.stop();
		new PeriodicalExecuter( refreshStatus, 5 );
	}
	function blink(pe) {
		$$('td.failureon').each( function( el ) {
			el.toggleClassName( "failureon1" );
		} );
		//$$('td.failureoff').each( function( el ) {
		//	el.toggleClassName( "failureoff1" );
		//} );
	}
	new PeriodicalExecuter( refreshStatusFirst, 0.1 );
	new PeriodicalExecuter( blink, 1 );
</script>

<form action="/journalize" method="post">

#if ( $ch.getPumpState(2).id() == 0 && $ch.getPumpState(3).id() == 0 )
	#set ( $backgroundImage = "img/pipes-big-12.png" )
#elseif ( $ch.getPumpState(3).id() == 0 )
	#set ( $backgroundImage = "img/pipes-big-123.png" )
#elseif ( $ch.getPumpState(0).id() == 0 && $ch.getPumpState(1).id() == 0 )
	#set ( $backgroundImage = "img/pipes-big-34.png" )
#else
	#set ( $backgroundImage = "img/pipes-big-1234.png" )
#end

<table width="1200px" style="padding-top: 0; border-collapse:collapse; background-image: url('$backgroundImage'); background-attachment: local; background-repeat:no-repeat; background-position: 270 305;" cellspacing="0" border="0">

<tr height="180px">
	<td width="260px" align="center">
		<font size="+5">СП-$ch.id</font>
		<div style="height: 10px"></div>
		<input type="button" onclick="window.location='/journal?id=$ch.id'" value="Журнал" style="font-size: 1.2em; line-height:1.2em ">
		<div style="height: 10px"></div>
		Последний удачный опрос <br>
		<span id="date">--</span>
	<td rowspan="2">&nbsp;</td>
	<td rowspan="3" colspan="3">
		<table style="border: 1px solid black; border-collapse:collapse;">
			<tr>
				<th style="border: 1px solid black; font-size: 0.9em" width="295px"><b>Название</b></td>
				#foreach ( $p in [0..3] )
					#set ( $pp = $p + 1 )
					#if ( $ch.getPumpState($p).id() != 0 )<th style="border: 1px solid black; font-size: 0.9em" width="100px"><b>Насос $pp</b></td>#end
				#end
			</tr>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Ток L1 - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_c1">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Ток L2 - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_c2">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Ток L3 - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_c3">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Напряжение - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_v">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Код аварии - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					
					#if ( $ch.getPumpState($p).id() != 0 )
					<td style="border: 1px solid black; font-size: 0.9em" onmouseover="Tip($('pump${p}_fcf').innerHTML)">
					<b><span id="pump${p}_fc">&nbsp;</span></b>
					<span id="pump${p}_fcf" style="display: none"></span>
					#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Режим работы насоса</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_wm">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Моточасы - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_mh">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Состояние - плавный пуск</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td style="border: 1px solid black; font-size: 0.9em"><b><span id="pump${p}_st">&nbsp;</span></b>#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Авария плавного пуска</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td id="pump${p}_fs" style="border: 1px solid black">&nbsp;#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Авария РТС насоса</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td id="pump${p}_fe" style="border: 1px solid black">&nbsp;#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Авария связи по Modbus с ПП</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td id="pump${p}_fm" style="border: 1px solid black">&nbsp;#end
				#end
			</td>
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Превышение счетчика моточасов</b></td>
				#foreach ( $p in [0..3] )
					#if ( $ch.getPumpState($p).id() != 0 )<td id="pump${p}_hco" style="border: 1px solid black">&nbsp;#end
				#end
			</td>
			#if ( $ch.getPumpState(3).id() != 0 )
			<tr>
				<td style="background-color: white; border: 1px solid black; font-size: 0.9em"><b>Авария автомата QF</b></td>
				#foreach ( $p in [0..3] )
					<td id="pump${p}_fqf" style="border: 1px solid black">&nbsp;
				#end
			</td>
			#end
		</table>
	</td>
	<td rowspan="2">&nbsp;</td>
<tr height="73px">
	<td width="280px" nowrap valign="top" align="center">
		<img id="connected" src="img/flag-link-off.png">
		<img id="mode" src="img/flag-mode-none.png">
		#if ( $ch.getPumpState(3).id() != 0 )
		<img id="voltage1" src="img/flag-voltage-none.png">
		<img id="voltage2" src="img/flag-voltage-none.png">
		<img id="adj" src="img/flag-adj-off.png">
		#else
		<img id="voltage" src="img/flag-voltage-none.png">
		#end
</tr>
<tr height="50px">
	<td width="280px" nowrap valign="top" align="center">
	<input id="journalize" type="button" value="Подтвердить" onclick="this.form.submit()" style="font-size: 1.5em; line-height:1.5em ">
</tr>
<tr height="52px">
	<td width="280px" rowspan="5" valign="top" align="center"><img id="tank" src="img/tank-big-0.png">
</tr>
<tr height="144px">
	<td width="106px">&nbsp;
	<td width="262px"><img #if ( $ch.getPumpState(2).id() == 0 ) style="display:none" #end id="pump2" src="img/pump-big-none.png">
	<td width="148px">&nbsp;
	<td width="262px"><img #if ( $ch.getPumpState(3).id() == 0 ) style="display:none" #end id="pump3" src="img/pump-big-none.png">
	<td>&nbsp;
</tr>
<tr height="130px">
	<td colspan="5">&nbsp;</td>
</tr>
<tr height="144px">
	<td width="106px">&nbsp;
	<td width="262px"><img #if ( $ch.getPumpState(0).id() == 0 ) style="display:none" #end id="pump0" src="img/pump-big-none.png">
	<td width="148px">&nbsp;
	<td width="262px"><img #if ( $ch.getPumpState(1).id() == 0 ) style="display:none" #end id="pump1" src="img/pump-big-none.png">
	<td>&nbsp;
</tr>
<tr>
	<td colspan="5"></td>
</tr>
</table>
<input type="hidden" name="id" value="$ch.id">
</form>
